# Azure DevOps Pipeline for KayTee E2E Tests
# Centralized E2E testing for all ecosystem applications

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'

pr:
  branches:
    include:
      - main
      - develop

# Scheduled runs - Weekly E2E test execution
schedules:
  # Monday 3 AM UTC - Full E2E suite
  - cron: '0 3 * * 1'
    displayName: 'Weekly E2E Tests (Monday 3 AM UTC)'
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '20.x'
  # Application URLs (production)
  KAYTEE_TROPICAL_URL: 'https://kayteetropical.com'
  QUALITY_METRICS_URL: 'https://qa.khannara.dev'
  PORTFOLIO_URL: 'https://khannara.dev'
  KAYTEE_HUB_URL: 'https://hub.kayteetropical.com'
  # Metrics API for reporting results
  METRICS_API_URL: 'https://api.khannara.dev'

stages:
  - stage: E2E_Tests
    displayName: 'E2E Tests'
    jobs:
      - job: QualityMetrics
        displayName: 'Quality Metrics Dashboard'
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'

          - script: npm run test:quality
            displayName: 'Run Quality Metrics E2E tests'
            env:
              CI: 'true'
              QUALITY_METRICS_URL: $(QUALITY_METRICS_URL)
              METRICS_API_URL: $(METRICS_API_URL)
              METRICS_API_KEY: $(METRICS_API_KEY)

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/e2e-results.xml'
              testRunTitle: 'Quality Metrics E2E Tests'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Playwright report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report-quality'

      - job: DigitalPortfolio
        displayName: 'Digital Portfolio'
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'

          - script: npm run test:portfolio
            displayName: 'Run Portfolio E2E tests'
            env:
              CI: 'true'
              PORTFOLIO_URL: $(PORTFOLIO_URL)
              METRICS_API_URL: $(METRICS_API_URL)
              METRICS_API_KEY: $(METRICS_API_KEY)

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/e2e-results.xml'
              testRunTitle: 'Digital Portfolio E2E Tests'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Playwright report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report-portfolio'

      - job: KayTeeTropical
        displayName: 'KayTee Tropical Dashboard'
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'

          - script: npm run test:tropical
            displayName: 'Run KayTee Tropical E2E tests'
            env:
              CI: 'true'
              KAYTEE_TROPICAL_URL: $(KAYTEE_TROPICAL_URL)
              METRICS_API_URL: $(METRICS_API_URL)
              METRICS_API_KEY: $(METRICS_API_KEY)
              # Auth credentials from pipeline variables (secret)
              TEST_USER_EMAIL: $(TEST_USER_EMAIL)
              TEST_USER_PASSWORD: $(TEST_USER_PASSWORD)

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/e2e-results.xml'
              testRunTitle: 'KayTee Tropical E2E Tests'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish Playwright report'
            condition: always()
            inputs:
              targetPath: 'playwright-report'
              artifact: 'playwright-report-tropical'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish screenshots'
            condition: failed()
            inputs:
              targetPath: 'test-results'
              artifact: 'test-artifacts-tropical'

      - job: KayTeeHub
        displayName: 'KayTee Tropical Hub'
        # Skip until hub is deployed
        condition: eq(variables['RUN_HUB_TESTS'], 'true')
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npx playwright install --with-deps chromium
            displayName: 'Install Playwright browsers'

          - script: npm run test:hub
            displayName: 'Run KayTee Hub E2E tests'
            env:
              CI: 'true'
              KAYTEE_HUB_URL: $(KAYTEE_HUB_URL)
              METRICS_API_URL: $(METRICS_API_URL)
              METRICS_API_KEY: $(METRICS_API_KEY)

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/e2e-results.xml'
              testRunTitle: 'KayTee Hub E2E Tests'

  - stage: Report
    displayName: 'Aggregate Results'
    dependsOn: E2E_Tests
    condition: always()
    jobs:
      - job: Summary
        displayName: 'Generate Summary'
        steps:
          - script: |
              echo "E2E Test Run Complete"
              echo "Date: $(date)"
              echo "Build: $(Build.BuildNumber)"
              echo "Branch: $(Build.SourceBranchName)"
            displayName: 'Print summary'
